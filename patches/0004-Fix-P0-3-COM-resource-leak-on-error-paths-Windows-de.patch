From 9a07b3f56d68aede4480e719c6ec7cbf2c961516 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Fri, 21 Nov 2025 11:15:52 +0000
Subject: [PATCH 4/7] Fix P0-3: COM resource leak on error paths (Windows
 device detection)

Problem:
- pythoncom.CoInitialize() was called BEFORE the try block in 5 locations
- If CoInitialize() succeeded but an exception occurred before entering the inner try,
  the finally block wouldn't execute, leaving COM in initialized state
- Repeated device scans would accumulate COM state corruption
- Windows Shell operations would fail after multiple device scans

Solution:
- Moved pythoncom.CoInitialize() INSIDE try blocks in all locations
- This ensures CoUninitialize() in finally always matches a successful CoInitialize()
- Proper pairing prevents COM thread state corruption

Locations fixed:
1. services/device_sources.py:640 - find_storage_item_by_path()
2. services/device_sources.py:737 - enumerate_folders_deep()
3. services/mtp_import_adapter.py:90 - enumerate_mtp_folder()
4. services/mtp_import_adapter.py:311 - import_selected_files()
5. workers/mtp_copy_worker.py:78 - run()

Impact:
- COM resources now properly cleaned up on ALL code paths
- Device detection stable across multiple scan operations
- No more COM state corruption on Windows

Files changed:
- services/device_sources.py: 2 locations fixed
- services/mtp_import_adapter.py: 2 locations fixed
- workers/mtp_copy_worker.py: 1 location fixed
---
 services/device_sources.py     | 11 +++++------
 services/mtp_import_adapter.py | 10 ++++------
 workers/mtp_copy_worker.py     |  8 ++++----
 3 files changed, 13 insertions(+), 16 deletions(-)

diff --git a/services/device_sources.py b/services/device_sources.py
index ce8e461..860fc4b 100644
--- a/services/device_sources.py
+++ b/services/device_sources.py
@@ -634,10 +634,10 @@ class DeviceScanner:
             print(f"[DeviceScanner] Finding storage item for path:")
             print(f"[DeviceScanner]   Target: {target_path}")
 
-            # Initialize COM
-            pythoncom.CoInitialize()
-
+            # P0-3 Fix: Initialize COM inside try block to ensure cleanup on all paths
+            # Moving CoInitialize inside try ensures CoUninitialize in finally always matches
             try:
+                pythoncom.CoInitialize()
                 shell = win32com.client.Dispatch("Shell.Application")
                 computer = shell.Namespace(17)  # This PC
 
@@ -732,10 +732,9 @@ class DeviceScanner:
             import win32com.client
             import pythoncom
 
-            # Initialize COM for this thread
-            pythoncom.CoInitialize()
-
+            # P0-3 Fix: Initialize COM inside try block to ensure cleanup on all paths
             try:
+                pythoncom.CoInitialize()
                 storage_folder = storage_item.GetFolder
                 if not storage_folder:
                     print(f"[DeviceScanner] âœ— Cannot access storage folder")
diff --git a/services/mtp_import_adapter.py b/services/mtp_import_adapter.py
index 866945b..1b80369 100644
--- a/services/mtp_import_adapter.py
+++ b/services/mtp_import_adapter.py
@@ -85,10 +85,9 @@ class MTPImportAdapter:
             import win32com.client
             import pythoncom
 
-            # Initialize COM in this thread
-            pythoncom.CoInitialize()
-
+            # P0-3 Fix: Initialize COM inside try block to ensure cleanup on all paths
             try:
+                pythoncom.CoInitialize()
                 # Navigate to device folder using "This PC" approach
                 shell = win32com.client.Dispatch("Shell.Application")
                 computer = shell.Namespace(17)  # This PC
@@ -307,10 +306,9 @@ class MTPImportAdapter:
             import win32com.client
             import pythoncom
 
-            # Initialize COM
-            pythoncom.CoInitialize()
-
+            # P0-3 Fix: Initialize COM inside try block to ensure cleanup on all paths
             try:
+                pythoncom.CoInitialize()
                 shell = win32com.client.Dispatch("Shell.Application")
                 dest_namespace = shell.Namespace(str(dest_folder))
 
diff --git a/workers/mtp_copy_worker.py b/workers/mtp_copy_worker.py
index 4d1f801..535b203 100644
--- a/workers/mtp_copy_worker.py
+++ b/workers/mtp_copy_worker.py
@@ -70,12 +70,12 @@ class MTPCopyWorker(QThread):
             import win32com.client
             import pythoncom
 
-            # CRITICAL: Initialize COM in this thread with apartment model
+            # P0-3 Fix: Initialize COM inside try block to ensure cleanup on all paths
+            # CRITICAL: COM must be initialized in this thread with apartment model
             # COM objects must be initialized in the thread where they're used
-            print(f"[MTPCopyWorker] Initializing COM in worker thread...")
-            pythoncom.CoInitialize()
-
             try:
+                print(f"[MTPCopyWorker] Initializing COM in worker thread...")
+                pythoncom.CoInitialize()
                 # Create Shell.Application in THIS thread (not main UI thread)
                 # COM objects are apartment-threaded and cannot be shared across threads
                 print(f"[MTPCopyWorker] Creating Shell.Application in worker thread...")
-- 
2.43.0

