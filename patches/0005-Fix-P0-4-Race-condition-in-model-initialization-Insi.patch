From 2acd42bcaee015882b314753d53cec4c95f6572f Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Fri, 21 Nov 2025 11:17:39 +0000
Subject: [PATCH 5/7] Fix P0-4: Race condition in model initialization
 (InsightFace)

Problem:
- Global _insightface_app was checked and initialized without thread synchronization
- Multiple concurrent calls to _get_insightface_app() could initialize model multiple times
- First thread checks `if _insightface_app is None:` (True)
- Second thread checks `if _insightface_app is None:` (True) - before first completes
- Both threads would attempt to load the model, wasting GPU memory and causing CUDA errors

Solution:
- Added threading.Lock (_model_lock) for thread-safe initialization
- Implemented double-checked locking pattern for performance:
  1. First check without lock (fast path for already-initialized case)
  2. Acquire lock if None
  3. Check again inside lock (another thread might have initialized)
  4. Only initialize if still None
- All initialization code now inside lock-protected block

Impact:
- Model initialization is now thread-safe and atomic
- No duplicate model loading even with concurrent face detection requests
- Performance maintained with double-checked locking (no lock overhead after first init)
- Prevents GPU memory waste and CUDA threading errors

Files changed:
- services/face_detection_service.py: Added threading.Lock and double-checked locking
---
 services/face_detection_service.py | 195 +++++++++++++++--------------
 1 file changed, 102 insertions(+), 93 deletions(-)

diff --git a/services/face_detection_service.py b/services/face_detection_service.py
index 78df44e..c50f8bf 100644
--- a/services/face_detection_service.py
+++ b/services/face_detection_service.py
@@ -10,12 +10,15 @@ from typing import List, Tuple, Optional
 from PIL import Image
 import logging
 import cv2
+import threading
 
 logger = logging.getLogger(__name__)
 
+# P0-4 Fix: Add thread lock for model initialization
 # Lazy import InsightFace (only load when needed)
 _insightface_app = None
 _providers_used = None
+_model_lock = threading.Lock()
 
 
 def _detect_available_providers():
@@ -148,101 +151,107 @@ def _get_insightface_app():
     - Model caching to avoid reloading
     """
     global _insightface_app, _providers_used
-    if _insightface_app is None:
-        try:
-            from insightface.app import FaceAnalysis
-
-            # Detect best available providers
-            providers, hardware_type = _detect_available_providers()
-            _providers_used = providers
-
-            # Find buffalo_l directory
-            buffalo_dir = _find_buffalo_directory()
-
-            if not buffalo_dir:
-                raise RuntimeError(
-                    "InsightFace models (buffalo_l) not found.\n\n"
-                    "Please configure the model path in Preferences ‚Üí Face Detection\n"
-                    "or download models using: python download_face_models.py"
-                )
-
-            # Save successful path to settings for future use
-            try:
-                from settings_manager_qt import SettingsManager
-                settings = SettingsManager()
-                current_saved = settings.get_setting('insightface_model_path', '')
-                # Only save if not already set (preserves user's manual configuration)
-                if not current_saved:
-                    settings.set_setting('insightface_model_path', buffalo_dir)
-                    logger.info(f"üíæ Saved InsightFace model path to settings: {buffalo_dir}")
-            except Exception as e:
-                logger.debug(f"Could not save model path to settings: {e}")
-
-            # CRITICAL: Pass buffalo_l directory DIRECTLY as root
-            # This matches the proof of concept approach from OldPy/photo_sorter.py
-            # Do NOT pass parent directory, pass the buffalo_l directory itself!
-            logger.info(f"‚úì Initializing InsightFace with buffalo_l directory: {buffalo_dir}")
-
-            # Version detection: Check if FaceAnalysis supports providers parameter
-            # This ensures compatibility with BOTH old and new InsightFace versions
-            import inspect
-            sig = inspect.signature(FaceAnalysis.__init__)
-            supports_providers = 'providers' in sig.parameters
-
-            # Initialize FaceAnalysis with version-appropriate parameters
-            init_params = {'name': 'buffalo_l', 'root': buffalo_dir}
-
-            if supports_providers:
-                # NEWER VERSION: Pass providers for optimal performance
-                init_params['providers'] = providers
-                logger.info(f"‚úì Using providers parameter (newer InsightFace): {providers}")
-                _insightface_app = FaceAnalysis(**init_params)
-
-                # For newer versions, ctx_id is derived from providers automatically
-                # But we still need to call prepare()
-                try:
-                    _insightface_app.prepare(ctx_id=-1, det_size=(640, 640))
-                    logger.info(f"‚úÖ InsightFace (buffalo_l) loaded successfully with {hardware_type} acceleration")
-                except Exception as prepare_error:
-                    logger.error(f"Model preparation failed: {prepare_error}")
-                    logger.error("This usually means:")
-                    logger.error("  1. Model files are corrupted or incomplete")
-                    logger.error("  2. InsightFace version incompatible with models")
-                    logger.error("  3. Wrong directory structure")
-                    raise RuntimeError(f"Failed to prepare InsightFace models: {prepare_error}") from prepare_error
-            else:
-                # OLDER VERSION: Use ctx_id approach (proof of concept compatibility)
-                logger.info(f"‚úì Using ctx_id approach (older InsightFace, proof of concept compatible)")
-                _insightface_app = FaceAnalysis(**init_params)
-
-                # Use providers ONLY for ctx_id selection (proof of concept approach)
-                use_cuda = isinstance(providers, (list, tuple)) and 'CUDAExecutionProvider' in providers
-                ctx_id = 0 if use_cuda else -1
-                logger.info(f"‚úì Using {hardware_type} acceleration (ctx_id={ctx_id})")
 
-                # Prepare model with simple parameters (matches proof of concept)
+    # P0-4 Fix: Double-checked locking for thread-safe initialization
+    # First check without lock for performance
+    if _insightface_app is None:
+        with _model_lock:
+            # Check again inside lock (another thread might have initialized)
+            if _insightface_app is None:
                 try:
-                    _insightface_app.prepare(ctx_id=ctx_id, det_size=(640, 640))
-                    logger.info(f"‚úÖ InsightFace (buffalo_l) loaded successfully with {hardware_type} acceleration")
-                except Exception as prepare_error:
-                    logger.error(f"Model preparation failed: {prepare_error}")
-                    logger.error("This usually means:")
-                    logger.error("  1. Model files are corrupted or incomplete")
-                    logger.error("  2. InsightFace version incompatible with models")
-                    logger.error("  3. Wrong directory structure")
-                    raise RuntimeError(f"Failed to prepare InsightFace models: {prepare_error}") from prepare_error
-
-        except ImportError as e:
-            logger.error(f"‚ùå InsightFace library not installed: {e}")
-            logger.error("Install with: pip install insightface onnxruntime")
-            raise ImportError(
-                "InsightFace library required for face detection. "
-                "Install with: pip install insightface onnxruntime"
-            ) from e
-        except Exception as e:
-            logger.error(f"‚ùå Failed to initialize InsightFace: {e}")
-            logger.error(f"Error details: {type(e).__name__}: {str(e)}")
-            raise
+                    from insightface.app import FaceAnalysis
+
+                    # Detect best available providers
+                    providers, hardware_type = _detect_available_providers()
+                    _providers_used = providers
+
+                    # Find buffalo_l directory
+                    buffalo_dir = _find_buffalo_directory()
+
+                    if not buffalo_dir:
+                        raise RuntimeError(
+                            "InsightFace models (buffalo_l) not found.\n\n"
+                            "Please configure the model path in Preferences ‚Üí Face Detection\n"
+                            "or download models using: python download_face_models.py"
+                        )
+
+                    # Save successful path to settings for future use
+                    try:
+                        from settings_manager_qt import SettingsManager
+                        settings = SettingsManager()
+                        current_saved = settings.get_setting('insightface_model_path', '')
+                        # Only save if not already set (preserves user's manual configuration)
+                        if not current_saved:
+                            settings.set_setting('insightface_model_path', buffalo_dir)
+                            logger.info(f"üíæ Saved InsightFace model path to settings: {buffalo_dir}")
+                    except Exception as e:
+                        logger.debug(f"Could not save model path to settings: {e}")
+
+                    # CRITICAL: Pass buffalo_l directory DIRECTLY as root
+                    # This matches the proof of concept approach from OldPy/photo_sorter.py
+                    # Do NOT pass parent directory, pass the buffalo_l directory itself!
+                    logger.info(f"‚úì Initializing InsightFace with buffalo_l directory: {buffalo_dir}")
+
+                    # Version detection: Check if FaceAnalysis supports providers parameter
+                    # This ensures compatibility with BOTH old and new InsightFace versions
+                    import inspect
+                    sig = inspect.signature(FaceAnalysis.__init__)
+                    supports_providers = 'providers' in sig.parameters
+
+                    # Initialize FaceAnalysis with version-appropriate parameters
+                    init_params = {'name': 'buffalo_l', 'root': buffalo_dir}
+
+                    if supports_providers:
+                        # NEWER VERSION: Pass providers for optimal performance
+                        init_params['providers'] = providers
+                        logger.info(f"‚úì Using providers parameter (newer InsightFace): {providers}")
+                        _insightface_app = FaceAnalysis(**init_params)
+
+                        # For newer versions, ctx_id is derived from providers automatically
+                        # But we still need to call prepare()
+                        try:
+                            _insightface_app.prepare(ctx_id=-1, det_size=(640, 640))
+                            logger.info(f"‚úÖ InsightFace (buffalo_l) loaded successfully with {hardware_type} acceleration")
+                        except Exception as prepare_error:
+                            logger.error(f"Model preparation failed: {prepare_error}")
+                            logger.error("This usually means:")
+                            logger.error("  1. Model files are corrupted or incomplete")
+                            logger.error("  2. InsightFace version incompatible with models")
+                            logger.error("  3. Wrong directory structure")
+                            raise RuntimeError(f"Failed to prepare InsightFace models: {prepare_error}") from prepare_error
+                    else:
+                        # OLDER VERSION: Use ctx_id approach (proof of concept compatibility)
+                        logger.info(f"‚úì Using ctx_id approach (older InsightFace, proof of concept compatible)")
+                        _insightface_app = FaceAnalysis(**init_params)
+
+                        # Use providers ONLY for ctx_id selection (proof of concept approach)
+                        use_cuda = isinstance(providers, (list, tuple)) and 'CUDAExecutionProvider' in providers
+                        ctx_id = 0 if use_cuda else -1
+                        logger.info(f"‚úì Using {hardware_type} acceleration (ctx_id={ctx_id})")
+
+                        # Prepare model with simple parameters (matches proof of concept)
+                        try:
+                            _insightface_app.prepare(ctx_id=ctx_id, det_size=(640, 640))
+                            logger.info(f"‚úÖ InsightFace (buffalo_l) loaded successfully with {hardware_type} acceleration")
+                        except Exception as prepare_error:
+                            logger.error(f"Model preparation failed: {prepare_error}")
+                            logger.error("This usually means:")
+                            logger.error("  1. Model files are corrupted or incomplete")
+                            logger.error("  2. InsightFace version incompatible with models")
+                            logger.error("  3. Wrong directory structure")
+                            raise RuntimeError(f"Failed to prepare InsightFace models: {prepare_error}") from prepare_error
+
+                except ImportError as e:
+                    logger.error(f"‚ùå InsightFace library not installed: {e}")
+                    logger.error("Install with: pip install insightface onnxruntime")
+                    raise ImportError(
+                        "InsightFace library required for face detection. "
+                        "Install with: pip install insightface onnxruntime"
+                    ) from e
+                except Exception as e:
+                    logger.error(f"‚ùå Failed to initialize InsightFace: {e}")
+                    logger.error(f"Error details: {type(e).__name__}: {str(e)}")
+                    raise
     return _insightface_app
 
 
-- 
2.43.0

